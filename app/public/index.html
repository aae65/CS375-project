<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <link href="/semantic/dist/semantic.min.css" rel="stylesheet">
    <script src="/semantic/dist/semantic.min.js"></script>
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map {
            height: 420px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 8px;
        }
    </style>
    <title>WIP</title>
</head>
<body>
    <div class="ui secondary pointing menu" style="padding: 1px">
        <a class="item active" data-tab="About Us">About Us</a>
        <a class="item" data-tab="create">Create a Session</a>
    </div>
    <div class="ui fluid bottom attached tab segment active" data-tab="About Us">
        hi
    </div>
    <div class="ui fluid bottom attached tab segment" data-tab="create">
        <div class="ui two column stackable grid">
            <div class="column">
                <form class="ui form" id="form" action="/session">
                    <div class="field">
                        <label>Name</label>
                        <input placeholder="First Name" name="name" type="text">
                    </div>
                    <div class="field">
                        <label>Email</label>
                        <input placeholder="Email" name="email" type="text">
                    </div>
                    <div class="field">
                        <label>Phone Number</label>
                        <input placeholder="Phone Number" name="phone" type="text">
                    </div>
                    <div class="field">
                        <label>Zip Code</label>
                        <input placeholder="Zip Code" name="zip" type="text">
                    </div>
                    <button class="ui primary button" id="submit">Submit</button>
                    <div class="ui error message" id="errorBox"></div>
                </form>
            </div>
        </div>
    </div>
<div class="ui secondary pointing menu" style="padding: 1px">
    <a class="item active" data-tab="home">Home</a>
    <a class="item" data-tab="group">Your Group</a>
    <a class="item" data-tab="vote">Voting</a>
</div>
<div class="ui fluid bottom attached tab segment active" data-tab="home">
    <div class="ui two column stackable grid">
        <div class="column">
            <button class="ui labeled icon button" id="generate">
                <i class="linkify icon"></i>
                Generate Link
            </button>
            <div class="ui modal" id="modal">
                <div class="center aligned header">Link Generated!</div>
                <div class="center aligned content">
                    <div class="ui fluid action input">
                        <input readonly type="text" value="placeholder">
                        <button class="ui teal right labeled icon button" id="copyLink">
                            <i class="copy icon"></i>
                            Copy
                        </button>
                        <div class="ui custom popup transition hidden" id="link-copied">
                            Link copied!
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="column">
            <div class="ui placeholder">
                <div class="image"></div>
                Map will go here
            </div>

        </div>
    </div>
</div>
<div class="ui bottom attached tab segment" data-tab="group">
    <div class="ui three column stackable grid">
        <div class="column">
            <div class="ui raised segment">
                <div class="ui placeholder">
                    <div class="image header">
                        <div class="line"></div>
                        <div class="line"></div>
                    </div>
                    <div class="paragraph">
                        <div class="medium line"></div>
                        <div class="short line"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="column">
            <div class="ui raised segment">
                <div class="ui placeholder">
                    <div class="image header">
                        <div class="line"></div>
                        <div class="line"></div>
                    </div>
                    <div class="paragraph">
                        <div class="medium line"></div>
                        <div class="short line"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="column">
            <div class="ui raised segment">
                <button class="ui teal button" id="locBtn">Use My Location</button>
                <div id="map"></div>
                <div class="paragraph">
                    <div class="medium line"></div>
                    <div class="short line"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<div class="ui bottom attached tab segment" data-tab="vote">
    <div class="ui fluid placeholder">
        <div class="image header">
            <div class="line"></div>
            <div class="line"></div>
        </div>
        <div class="paragraph">
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
        </div>
    </div>
</div>
</body>
<script>
    let generateLink = document.getElementById("generate");
    let modal = document.getElementById("modal");
    let copyLink = document.getElementById("copyLink");
    let linkCopied = document.getElementById('link-copied');
    let linkInput = document.querySelector('#modal input[type="text"]');

    generateLink.addEventListener('click', () => {
        fetch('/generate-session')
        .then(response => response.json())
        .then(data => {
            linkInput.value = data.link;
            $(modal).modal('show');
        })
        .catch(error => {
            console.error('Error generating link:', error);
        });
    });

    copyLink.addEventListener('click', () => {
        linkInput.select();
        linkInput.setSelectionRange(0, 99999);
        document.execCommand('copy');
        $(copyLink).popup('show');
    });

    $(copyLink).popup({
        popup: linkCopied,
        position: 'top center',
        on: 'manual'
    });

    // Leaflet & OpenStreetMap
    let map, marker;

    function initMap() {
        map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap Contributors'
        }).addTo(map);
    }

    function showLocation() {
        if (!navigator.geolocation) {
            alert("Geolocation not supported by your browser")
            return;
        }

        navigator.geolocation.getCurrentPosition((position) => {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                map.setView([latitude, longitude], 14);

                if (marker) marker.remove();

                marker = L.marker([latitude, longitude])
                    .addTo(map)
                    .bindPopup("You are here")
                    .openPopup();
            },
            (error) => {
                alert("Could not get location:" + error.message);
            },
            {enableHighAccuracy: true, timeout: 5000}
        );
    }

    $('.menu .item').tab({
        onVisible: function (tabName) {
            if (tabName === 'group') {
                initMap();
                setTimeout(() => map && map.invalidateSize(), 0)
            }
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
        const locBtn = document.getElementById('locBtn');
        if (locBtn) locBtn.addEventListener('click', showLocation);

        const groupActive = document.querySelector('.ui.tab.active[date-tab="group"]');
        if (groupActive) {
            initMap();
            setTimeout(() => map && map.invalidateSize(), 0);
        }
    })
</script>
<script src="form.js"></script>
</html>